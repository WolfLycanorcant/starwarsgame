<!DOCTYPE html>
<html>
<head>
    <title>Game Master</title>
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .axis-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 150px;
        }
        .control-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .axis-label {
            font-size: 1.2em;
        }
        .axis-value {
            font-size: 2em;
        }
        .vertical-slider {
            width: 20px;
            height: 200px;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
        }
        .vertical-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--starwars-yellow);
            cursor: pointer;
        }
        .speed-control {
            width: 100%;
            max-width: 300px;
        }
        .instrument-panel {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        :root {
            --starwars-blue: #007bff;
            --starwars-green: #22b14c;
            --starwars-yellow: #ffd700;
        }
        
        .artificial-horizon {
            width: 300px;
            height: 200px;
            background: #000;
            border: 2px solid var(--starwars-blue);
            position: relative;
            overflow: hidden;
            transform: scaleX(-1);
        }
        .artificial-horizon .horizon-line,
        .artificial-horizon .pitch-indicator,
        .artificial-horizon .roll-indicator,
        .artificial-horizon .degree-mark {
            transform: scaleX(-1);
        }
        .radio-altimeter {
            width: 200px;
            height: 200px;
            background: #000;
            border: 2px solid var(--starwars-blue);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .altimeter-dial {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 2px solid var(--starwars-yellow);
            position: relative;
            background: radial-gradient(circle at center, #000 0%, #1a1a1a 100%);
        }
        .altimeter-needle {
            position: absolute;
            width: 2px;
            height: 90px;
            background: var(--starwars-yellow);
            transform-origin: bottom center;
            left: 50%;
            transform: translateX(-50%);
        }
        .altimeter-value {
            position: absolute;
            font-size: 1.5em;
            color: var(--starwars-yellow);
            text-align: center;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
        }
        .altimeter-label {
            position: absolute;
            font-size: 0.8em;
            color: var(--starwars-yellow);
            text-align: center;
            width: 100%;
            bottom: 10px;
        }
        .horizon-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--starwars-yellow);
            top: 50%;
        }
        .pitch-indicator {
            position: absolute;
            left: 50%;
            top: 0%;
            width: 2px;
            height: 100%;
            background: var(--starwars-blue);
            transform-origin: center center;
        }
        .roll-indicator {
            position: absolute;
            left: 0%;
            top: 50%;
            width: 100%;
            height: 2px;
            background: var(--starwars-green);
            transform-origin: center center;
        }
        .degree-mark {
            position: absolute;
            width: 2px;
            height: 10px;
            background: var(--starwars-yellow);
            left: 50%;
            transform: translateX(-50%);
        }
        .confirm-button {
            background: var(--starwars-yellow);
            color: #000;
            padding: 10px 20px;
            border: 2px solid var(--starwars-blue);
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        .confirm-button:hover {
            background: var(--starwars-blue);
            color: #fff;
        }
        .macro-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .macro-button {
            background: var(--starwars-yellow);
            color: #000;
            border: 2px solid var(--starwars-blue);
            padding: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .macro-button:hover {
            background: var(--starwars-blue);
            color: #fff;
            transform: scale(1.05);
        }
        .macro-button:active {
            transform: scale(0.95);
        }
        .macro-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl mb-6">GAME MASTER CONTROL</h1>
        
        <!-- Mission Controls -->
        <div class="control-panel">
            <div class="axis-control">
                <div class="axis-label">MISSION STATUS</div>
                <div id="mission-status" class="axis-value">Active</div>
                <div class="macro-buttons">
                    <button class="macro-button" onclick="GameMaster.setMissionStatus('Active')">
                        [ðŸŸ¢ ACTIVE]
                    </button>
                    <button class="macro-button" onclick="GameMaster.setMissionStatus('Critical')">
                        [ðŸ”´ CRITICAL]
                    </button>
                    <button class="macro-button" onclick="GameMaster.setMissionStatus('Complete')">
                        [ðŸŸ¢ COMPLETE]
                    </button>
                </div>
            </div>
        </div> 

        <!-- Navigation Controls -->
        <div class="control-panel">
            <div class="control-row">
                <div class="axis-control">
                    <div class="axis-label">HEADING X</div>
                    <div class="axis-value" id="heading-x">0Â°</div>
                    <input type="range" id="heading-x-control" min="-180" max="180" step="1" class="vertical-slider">
                </div>
                <div class="axis-control">
                    <div class="axis-label">HEADING Y</div>
                    <div class="axis-value" id="heading-y">0Â°</div>
                    <input type="range" id="heading-y-control" min="-90" max="90" step="1" class="vertical-slider">
                </div>
                <div class="axis-control">
                    <div class="axis-label">SPEED</div>
                    <div class="axis-value" id="speed">0</div>
                    <input type="range" id="speed-control" min="0" max="100" step="1" class="vertical-slider">
                </div>
            </div>
        </div>

        <!-- Instruments -->
        <div class="instrument-panel">
            <!-- Radio Altimeter -->
            <div class="radio-altimeter">
                <div class="altimeter-dial">
                    <div class="altimeter-needle" id="altimeter-needle"></div>
                    <div class="altimeter-value" id="altimeter-value">0</div>
                    <div class="altimeter-label">ALTITUDE (k)</div>
                </div>
            </div>
            
            <!-- Artificial Horizon -->
            <div class="artificial-horizon">
                <div class="horizon-line"></div>
                <div class="pitch-indicator"></div>
                <div class="roll-indicator"></div>
            </div>
        </div>

        <div class="control-row">
            <div class="axis-control">
                <div class="axis-label">ALERT STATUS</div>
                <select id="alert-status" class="bg-black border p-2">
                    <option>NORMAL</option>
                    <option>YELLOW</option>
                    <option>RED</option>
                </select>
            </div>
            <div class="axis-control">
                <div class="axis-label">WEAPONS</div>
                <div class="axis-value" id="weapons-value">100%</div>
                <input type="number" id="weapons-status" min="0" max="100" class="bg-black border p-2">
            </div>
            <div class="axis-control">
                <div class="axis-label">POWER</div>
                <div class="axis-value" id="power-value">100%</div>
                <input type="number" id="power-status" min="0" max="100" class="bg-black border p-2">
            </div>
            <div class="axis-control">
                <div class="axis-label">ALTITUDE</div>
                <div class="axis-value" id="altitude-value">0k</div>
                <input type="number" id="altitude-status" min="0" max="100" step="0.1" class="bg-black border p-2">
            </div>
        </div>
        <div class="axis-control" style="width: 100%;">
            <div class="axis-label">HULL MESSAGE</div>
            <textarea id="hull-message" rows="2" class="bg-black border p-2 w-full"></textarea>
        </div>
        
        <!-- Communications Controls -->
        <div class="gm-control">
            <h2>Communications</h2>
            <div class="grid">
                <div>
                    <label class="gm-label">Current Frequency</label>
                    <div id="current-frequency" class="gm-value">121.5</div>
                    <input type="number" id="new-frequency" step="0.1" class="bg-black border p-2 w-full" placeholder="Enter frequency">
                </div>
            </div>
        </div>

        <!-- Update Button -->
        <button onclick="GameMaster.updateGameState()" class="bg-red-600 px-6 py-3 mt-4">
            UPDATE ALL STATIONS
        </button>
    </div>

    <script>
        // Game Master Controller
        const GameMaster = {
            // State references
            elements: {
                missionStatus: document.getElementById('mission-status'),
                headingX: document.getElementById('heading-x'),
                headingY: document.getElementById('heading-y'),
                speed: document.getElementById('speed'),
                alertStatus: document.getElementById('alert-status'),
                weaponsStatus: document.getElementById('weapons-status'),
                powerStatus: document.getElementById('power-status'),
                altitudeStatus: document.getElementById('altitude-status'),
                hullMessage: document.getElementById('hull-message'),
                newFrequency: document.getElementById('new-frequency'),
                // Instrument elements
                pitchIndicator: document.querySelector('.artificial-horizon .pitch-indicator'),
                rollIndicator: document.querySelector('.artificial-horizon .roll-indicator'),
                altimeterNeedle: document.querySelector('.altimeter-needle'),
                altimeterValue: document.querySelector('.altimeter-value')
            },

            // Socket connection
            socket: io(),
            room: new URLSearchParams(window.location.search).get('room'),

            // Initialize
            init() {
                if (!this.room) {
                    console.error('No room parameter provided');
                    alert('Please provide a room parameter in the URL');
                    return;
                }
                
                console.log('Joining room:', this.room);
                this.socket.emit('join', { 
                    room: this.room, 
                    station: 'gm' 
                });
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Listen for state updates
                this.socket.on('state_update', (state) => {
                    console.log('Received state:', state);
                    this.updateUI(state);
                });
            },

            // Set up all control event listeners
            setupEventListeners() {
                // Navigation controls
                document.getElementById('heading-x-control').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.headingX.textContent = value + 'Â°';
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { heading: { x: value } }
                    });
                });

                document.getElementById('heading-y-control').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.headingY.textContent = value + 'Â°';
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { heading: { y: value } }
                    });
                });

                document.getElementById('speed-control').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.speed.textContent = value;
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { speed: value }
                    });
                });

                // System controls
                document.getElementById('alert-status').addEventListener('change', (e) => {
                    const value = e.target.value;
                    this.elements.alertStatus.value = value;
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { alert: value }
                    });
                });

                document.getElementById('altitude-status').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.altitudeStatus.value = value;
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { altitude: value }
                    });
                });

                document.getElementById('weapons-status').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.weaponsStatus.value = value;
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { systems: { weapons: value } }
                    });
                });

                document.getElementById('power-status').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.elements.powerStatus.value = value;
                    this.socket.emit('gm_update', {
                        room: this.room,
                        changes: { systems: { power: value } }
                    });
                });

                // Mission status button
                document.querySelectorAll('.macro-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const status = e.target.textContent.trim().replace(/\[|\]/g, '').split(' ')[1];
                        this.setMissionStatus(status);
                    });
                });
            },

            // Update UI from state
            updateUI(state) {
                // Update instrument displays
                this.updateInstruments(state);
                
                // Update control values
                this.elements.headingX.textContent = state.heading.x + 'Â°';
                this.elements.headingY.textContent = state.heading.y + 'Â°';
                this.elements.speed.textContent = state.speed;
                this.elements.alertStatus.value = state.alert;
                this.elements.altitudeStatus.value = state.altitude;
                this.elements.weaponsStatus.value = state.systems.weapons;
                this.elements.powerStatus.value = state.systems.power;
                this.elements.hullMessage.value = state.systems.hull_message;
                this.elements.newFrequency.value = state.frequency;
                this.elements.missionStatus.textContent = state.mission_status || 'Active';
            },

            // Update instrument displays
            updateInstruments(state) {
                if (this.elements.pitchIndicator && this.elements.rollIndicator) {
                    this.elements.pitchIndicator.style.transform = `rotate(${-state.heading.y}deg) translateX(-50%) translateY(-10%) scaleX(-1)`;
                    this.elements.rollIndicator.style.transform = `rotate(${state.heading.x}deg) translateY(-50%) scaleX(-1)`;
                }
                
                if (this.elements.altimeterNeedle) {
                    const maxAltitude = 100;  // Maximum altitude in kilometers
                    const angle = (state.altitude / maxAltitude) * 180;
                    this.elements.altimeterNeedle.style.transform = `rotate(${angle}deg)`;
                    if (this.elements.altimeterValue) {
                        this.elements.altimeterValue.textContent = state.altitude;
                    }
                }
                
                // Update altitude value display
                if (this.elements.altitudeStatus) {
                    this.elements.altitudeStatus.value = state.altitude;
                }
            },

            // Mission status handler
            setMissionStatus(status) {
                this.elements.missionStatus.textContent = status;
                this.socket.emit('gm_update', {
                    room: this.room,
                    changes: { mission_status: status }
                });
            }
        };

        // Start the controller
        GameMaster.init();
    </script>
</body>
</html>